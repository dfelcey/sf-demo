name: Remote Deploy with Interactive Login
on:
  workflow_dispatch: # Allows the curl trigger with specific inputs
    inputs:
      sf_access_token:
        description: 'Salesforce Access Token (from authenticated org)'
        required: false
        type: string
      sf_instance_url:
        description: 'Salesforce Instance URL (e.g., https://login.salesforce.com)'
        required: false
        type: string
  repository_dispatch:
    types: [deploy]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate to Salesforce
        id: login
        timeout-minutes: 10
        run: |
          echo "=========================================="
          echo "üîê Salesforce Authentication"
          echo "=========================================="
          
          # Get credentials from repository_dispatch or workflow_dispatch inputs
          SF_ACCESS_TOKEN="${{ inputs.sf_access_token || github.event.client_payload.sf_access_token }}"
          SF_INSTANCE_URL="${{ inputs.sf_instance_url || github.event.client_payload.sf_instance_url }}"
          
          # Check if credentials provided via inputs (from web portal)
          if [ -n "$SF_ACCESS_TOKEN" ] && [ -n "$SF_INSTANCE_URL" ]; then
            echo "Using credentials from web portal authentication..."
            sf org login access-token \
              --alias targetOrg \
              --instance-url "$SF_INSTANCE_URL" \
              --access-token "$SF_ACCESS_TOKEN" || {
              echo "‚ùå Authentication with provided credentials failed"
              exit 1
            }
            echo "‚úÖ Authentication successful using provided credentials!"
          # Check if access token is provided via secrets (fallback)
          elif [ -n "${{ secrets.SF_ACCESS_TOKEN }}" ] && [ -n "${{ secrets.SF_INSTANCE_URL }}" ]; then
            echo "Using GitHub Secrets (Access Token) for authentication..."
            sf org login access-token \
              --alias targetOrg \
              --instance-url "${{ secrets.SF_INSTANCE_URL }}" \
              --access-token "${{ secrets.SF_ACCESS_TOKEN }}" || {
              echo "‚ùå Authentication with access token failed"
              exit 1
            }
            echo "‚úÖ Authentication successful using Access Token!"
          else
            echo "GitHub Secrets not configured. Using device login..."
            echo "Please watch the logs below for the Device Login code!"
            echo "You will need to visit the URL and enter the code to authenticate."
            echo ""
            echo "To use automatic authentication (no device login needed), set these GitHub Secrets:"
            echo "  - SF_ACCESS_TOKEN: Your Salesforce access token"
            echo "  - SF_INSTANCE_URL: Your instance URL (e.g., https://login.salesforce.com)"
            echo ""
            echo "You can get your access token after logging in locally with:"
            echo "  sf org display --target-org <alias> --json | jq -r '.result.accessToken'"
            echo ""
            # This command will output a URL (https://login.salesforce.com/setup/connect) 
            # and a 8-digit code.
            sf org login device --alias targetOrg --instance-url https://login.salesforce.com || {
              echo "‚ùå Device login failed or timed out"
              echo "Please check the logs above for the device code and complete authentication"
              exit 1
            }
            echo ""
            echo "‚úÖ Authentication successful via device login!"
          fi

      - name: Deploy Assets
        run: |
          echo "üöÄ Starting deployment to Salesforce..."
          # This runs as soon as you finish the login on your machine
          sf project deploy start --source-dir force-app --target-org targetOrg --wait 10 || {
            echo "‚ùå Deployment failed"
            exit 1
          }
          echo "‚úÖ Deployment completed successfully!"

