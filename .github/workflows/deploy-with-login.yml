name: Remote Deploy with Interactive Login
on:
  workflow_dispatch: # Allows the curl trigger with specific inputs
    inputs:
      sf_access_token:
        description: 'Salesforce Access Token (from authenticated org)'
        required: false
        type: string
      sf_instance_url:
        description: 'Salesforce Instance URL (e.g., https://login.salesforce.com)'
        required: false
        type: string
  repository_dispatch:
    types: [deploy]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate to Salesforce
        id: login
        timeout-minutes: 10
        run: |
          echo "=========================================="
          echo "üîê Salesforce Authentication"
          echo "=========================================="
          echo ""
          echo "Using Device Login (no Connected App required)"
          echo ""
          echo "üìã INSTRUCTIONS:"
          echo "1. Watch the logs below for a Device Login code (8 digits)"
          echo "2. Visit the URL shown below"
          echo "3. Enter the code when prompted"
          echo "4. Complete authentication on Salesforce"
          echo ""
          echo "=========================================="
          echo ""
          
          # Get instance URL from input or use default
          SF_INSTANCE_URL="${{ inputs.sf_instance_url || github.event.client_payload.sf_instance_url }}"
          SF_INSTANCE_URL="${SF_INSTANCE_URL:-https://login.salesforce.com}"
          
          # Use device login (no Connected App needed)
          echo "Starting device login flow..."
          echo "Instance URL: $SF_INSTANCE_URL"
          echo ""
          
          sf org login device --alias targetOrg --instance-url "$SF_INSTANCE_URL" || {
              echo ""
              echo "‚ùå Device login failed or timed out"
              echo ""
              echo "Troubleshooting:"
              echo "- Check the logs above for the device code"
              echo "- Make sure you visit the URL and enter the code within 10 minutes"
              echo "- Verify your Salesforce org URL is correct"
              exit 1
          }
          
          echo ""
          echo "‚úÖ Authentication successful via device login!"

      - name: Deploy Assets
        run: |
          echo "üöÄ Starting deployment to Salesforce..."
          # This runs as soon as you finish the login on your machine
          sf project deploy start --source-dir force-app --target-org targetOrg --wait 10 || {
            echo "‚ùå Deployment failed"
            exit 1
          }
          echo "‚úÖ Deployment completed successfully!"

