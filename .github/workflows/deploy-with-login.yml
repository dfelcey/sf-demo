name: Salesforce Deployment
on:
  workflow_dispatch: # Allows manual trigger or API trigger
    inputs:
      sf_access_token:
        description: 'Salesforce Access Token (from browser login)'
        required: false
        type: string
      sf_instance_url:
        description: 'Salesforce Instance URL (e.g., https://login.salesforce.com)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          set -e  # Exit on error
          echo "Checking for Salesforce CLI..."
          
          # Check if sf CLI is already installed
          if command -v sf &> /dev/null; then
            echo "‚úÖ Salesforce CLI found: $(sf --version)"
          else
            echo "üì¶ Salesforce CLI not found. Installing..."
            
            # Check if Node.js/npm is available
            if ! command -v npm &> /dev/null; then
              echo "‚ùå npm is not installed. Installing Node.js..."
              # Install Node.js (required for npm)
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
              echo "‚úÖ Node.js installed: $(node --version)"
              echo "‚úÖ npm installed: $(npm --version)"
            fi
            
            echo "Installing Salesforce CLI via npm..."
            npm install -g @salesforce/cli || {
              echo "‚ùå Failed to install Salesforce CLI"
              echo "Trying alternative installation method..."
              # Alternative: use npm with --force or try different approach
              npm install -g @salesforce/cli --force || {
                echo "‚ùå Installation failed. Please check npm and Node.js versions."
                echo "Node version: $(node --version)"
                echo "npm version: $(npm --version)"
                exit 1
              }
            }
            
            # Verify installation
            if command -v sf &> /dev/null; then
              echo "‚úÖ Salesforce CLI installed successfully: $(sf --version)"
            else
              echo "‚ùå Salesforce CLI installation completed but 'sf' command not found"
              echo "Checking PATH and installation location..."
              npm list -g @salesforce/cli || true
              echo "PATH: $PATH"
              echo "npm prefix: $(npm config get prefix)"
              exit 1
            fi
          fi
          
          # Ensure sf is in PATH
          export PATH="$PATH:$(npm config get prefix)/bin"
          echo "Salesforce CLI ready: $(sf --version)"
          echo "CLI location: $(which sf)"

      - name: Authenticate to Salesforce
        id: login
        timeout-minutes: 10
        run: |
          set -e  # Exit on error
          echo "=========================================="
          echo "üîê Salesforce Authentication"
          echo "=========================================="
          
          # Get credentials from workflow inputs (from local browser login)
          SF_ACCESS_TOKEN="${{ inputs.sf_access_token }}"
          SF_INSTANCE_URL="${{ inputs.sf_instance_url }}"
          
          # Debug: Check if inputs are provided (without showing token)
          echo "Debug: Checking inputs..."
          if [ -n "$SF_ACCESS_TOKEN" ]; then
            echo "‚úÖ Access token provided (length: ${#SF_ACCESS_TOKEN} chars)"
          else
            echo "‚ö†Ô∏è  No access token provided"
          fi
          
          if [ -n "$SF_INSTANCE_URL" ]; then
            echo "‚úÖ Instance URL provided: $SF_INSTANCE_URL"
          else
            echo "‚ö†Ô∏è  No instance URL provided"
          fi
          echo ""
          
          # Check if credentials provided via inputs (from local browser login)
          if [ -n "$SF_ACCESS_TOKEN" ] && [ -n "$SF_INSTANCE_URL" ]; then
            echo "Using credentials from browser login..."
            echo "Attempting to authenticate with access token..."
            
            # Try access-token login
            if sf org login access-token \
              --alias targetOrg \
              --instance-url "$SF_INSTANCE_URL" \
              --access-token "$SF_ACCESS_TOKEN" 2>&1; then
              echo "‚úÖ Authentication successful using browser login credentials!"
            else
              echo ""
              echo "‚ùå Authentication with access token failed"
              echo ""
              echo "This might happen if:"
              echo "- The access token has expired"
              echo "- The token format is incorrect"
              echo "- The instance URL doesn't match the token"
              echo ""
              echo "Falling back to Device Login..."
              echo ""
              
              # Fall back to device login
              SF_INSTANCE_URL="${SF_INSTANCE_URL:-https://login.salesforce.com}"
              echo "Using Device Login with instance URL: $SF_INSTANCE_URL"
              echo ""
              echo "üìã INSTRUCTIONS:"
              echo "1. Watch the logs below for a Device Login code (8 digits)"
              echo "2. Visit the URL shown below"
              echo "3. Enter the code when prompted"
              echo "4. Complete authentication on Salesforce"
              echo ""
              echo "=========================================="
              echo ""
              
              sf org login device --alias targetOrg --instance-url "$SF_INSTANCE_URL" || {
                  echo ""
                  echo "‚ùå Device login failed or timed out"
                  echo ""
                  echo "Troubleshooting:"
                  echo "- Check the logs above for the device code"
                  echo "- Make sure you visit the URL and enter the code within 10 minutes"
                  echo "- Verify your Salesforce org URL is correct"
                  exit 1
              }
              
              echo ""
              echo "‚úÖ Authentication successful via device login!"
            fi
          else
            echo "No credentials provided. Using Device Login..."
            echo ""
            echo "üìã INSTRUCTIONS:"
            echo "1. Watch the logs below for a Device Login code (8 digits)"
            echo "2. Visit the URL shown below"
            echo "3. Enter the code when prompted"
            echo "4. Complete authentication on Salesforce"
            echo ""
            echo "=========================================="
            echo ""
            
            # Get instance URL from input or use default
            SF_INSTANCE_URL="${SF_INSTANCE_URL:-https://login.salesforce.com}"
            
            # Use device login as fallback
            sf org login device --alias targetOrg --instance-url "$SF_INSTANCE_URL" || {
                echo ""
                echo "‚ùå Device login failed or timed out"
                echo ""
                echo "Troubleshooting:"
                echo "- Check the logs above for the device code"
                echo "- Make sure you visit the URL and enter the code within 10 minutes"
                echo "- Verify your Salesforce org URL is correct"
                exit 1
            }
            
            echo ""
            echo "‚úÖ Authentication successful via device login!"
          fi
          
          # Verify authentication worked
          echo ""
          echo "Verifying authentication..."
          sf org display --target-org targetOrg --json > /dev/null 2>&1 || {
            echo "‚ùå Failed to verify authentication"
            echo "Org might not be authenticated properly"
            exit 1
          }
          echo "‚úÖ Authentication verified!"

      - name: Deploy Assets
        run: |
          set -e  # Exit on error
          echo "üöÄ Starting deployment to Salesforce..."
          
          # Verify org is authenticated before deploying
          echo "Verifying target org..."
          sf org display --target-org targetOrg --json > /dev/null 2>&1 || {
            echo "‚ùå Target org 'targetOrg' is not authenticated"
            echo "Available orgs:"
            sf org list || true
            exit 1
          }
          
          echo "‚úÖ Target org verified"
          echo ""
          
          # This runs as soon as you finish the login on your machine
          echo "Deploying from force-app directory..."
          sf project deploy start --source-dir force-app --target-org targetOrg --wait 10 || {
            echo ""
            echo "‚ùå Deployment failed"
            echo ""
            echo "Troubleshooting:"
            echo "- Check the error messages above"
            echo "- Verify the org has the necessary permissions"
            echo "- Ensure the metadata is valid"
            exit 1
          }
          echo ""
          echo "‚úÖ Deployment completed successfully!"

