name: Salesforce Deployment
on:
  workflow_dispatch: # Allows manual trigger or API trigger
    inputs:
      sf_access_token:
        description: 'Salesforce Access Token (from browser login)'
        required: false
        type: string
      sf_instance_url:
        description: 'Salesforce Instance URL (e.g., https://login.salesforce.com)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          echo "Checking for Salesforce CLI..."
          
          # Check if sf CLI is already installed
          if command -v sf &> /dev/null; then
            echo "‚úÖ Salesforce CLI found: $(sf --version)"
          else
            echo "üì¶ Salesforce CLI not found. Installing..."
            
            # Check if Node.js/npm is available
            if ! command -v npm &> /dev/null; then
              echo "‚ùå npm is not installed. Installing Node.js..."
              # Install Node.js (required for npm)
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            echo "Installing Salesforce CLI via npm..."
            npm install -g @salesforce/cli || {
              echo "‚ùå Failed to install Salesforce CLI"
              echo "Trying alternative installation method..."
              # Alternative: use npm with --force or try different approach
              npm install -g @salesforce/cli --force || {
                echo "‚ùå Installation failed. Please check npm and Node.js versions."
                exit 1
              }
            }
            
            # Verify installation
            if command -v sf &> /dev/null; then
              echo "‚úÖ Salesforce CLI installed successfully: $(sf --version)"
            else
              echo "‚ùå Salesforce CLI installation completed but 'sf' command not found"
              echo "Checking PATH and installation location..."
              npm list -g @salesforce/cli || true
              exit 1
            fi
          fi
          
          # Ensure sf is in PATH
          export PATH="$PATH:$(npm config get prefix)/bin"
          echo "Salesforce CLI ready: $(sf --version)"

      - name: Authenticate to Salesforce
        id: login
        timeout-minutes: 10
        run: |
          echo "=========================================="
          echo "üîê Salesforce Authentication"
          echo "=========================================="
          
          # Get credentials from workflow inputs (from local browser login)
          SF_ACCESS_TOKEN="${{ inputs.sf_access_token }}"
          SF_INSTANCE_URL="${{ inputs.sf_instance_url }}"
          
          # Check if credentials provided via inputs (from local browser login)
          if [ -n "$SF_ACCESS_TOKEN" ] && [ -n "$SF_INSTANCE_URL" ]; then
            echo "Using credentials from browser login..."
            sf org login access-token \
              --alias targetOrg \
              --instance-url "$SF_INSTANCE_URL" \
              --access-token "$SF_ACCESS_TOKEN" || {
              echo "‚ùå Authentication with provided credentials failed"
              exit 1
            }
            echo "‚úÖ Authentication successful using browser login credentials!"
          else
            echo "No credentials provided. Using Device Login as fallback..."
            echo ""
            echo "üìã INSTRUCTIONS:"
            echo "1. Watch the logs below for a Device Login code (8 digits)"
            echo "2. Visit the URL shown below"
            echo "3. Enter the code when prompted"
            echo "4. Complete authentication on Salesforce"
            echo ""
            echo "=========================================="
            echo ""
            
            # Get instance URL from input or use default
            SF_INSTANCE_URL="${SF_INSTANCE_URL:-https://login.salesforce.com}"
            
            # Use device login as fallback
            sf org login device --alias targetOrg --instance-url "$SF_INSTANCE_URL" || {
                echo ""
                echo "‚ùå Device login failed or timed out"
                echo ""
                echo "Troubleshooting:"
                echo "- Check the logs above for the device code"
                echo "- Make sure you visit the URL and enter the code within 10 minutes"
                echo "- Verify your Salesforce org URL is correct"
                exit 1
            }
            
            echo ""
            echo "‚úÖ Authentication successful via device login!"
          fi

      - name: Deploy Assets
        run: |
          echo "üöÄ Starting deployment to Salesforce..."
          # This runs as soon as you finish the login on your machine
          sf project deploy start --source-dir force-app --target-org targetOrg --wait 10 || {
            echo "‚ùå Deployment failed"
            exit 1
          }
          echo "‚úÖ Deployment completed successfully!"

