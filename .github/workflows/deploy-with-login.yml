name: Salesforce Deployment via Device Login
on:
  workflow_dispatch: # Allows manual trigger or API trigger
    inputs:
      sf_instance_url:
        description: 'Salesforce Instance URL (e.g., https://login.salesforce.com)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          echo "Checking for Salesforce CLI..."
          
          # Check if sf CLI is already installed
          if command -v sf &> /dev/null; then
            echo "‚úÖ Salesforce CLI found: $(sf --version)"
          else
            echo "üì¶ Salesforce CLI not found. Installing..."
            
            # Check if Node.js/npm is available
            if ! command -v npm &> /dev/null; then
              echo "‚ùå npm is not installed. Installing Node.js..."
              # Install Node.js (required for npm)
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            echo "Installing Salesforce CLI via npm..."
            npm install -g @salesforce/cli || {
              echo "‚ùå Failed to install Salesforce CLI"
              echo "Trying alternative installation method..."
              # Alternative: use npm with --force or try different approach
              npm install -g @salesforce/cli --force || {
                echo "‚ùå Installation failed. Please check npm and Node.js versions."
                exit 1
              }
            }
            
            # Verify installation
            if command -v sf &> /dev/null; then
              echo "‚úÖ Salesforce CLI installed successfully: $(sf --version)"
            else
              echo "‚ùå Salesforce CLI installation completed but 'sf' command not found"
              echo "Checking PATH and installation location..."
              npm list -g @salesforce/cli || true
              exit 1
            fi
          fi
          
          # Ensure sf is in PATH
          export PATH="$PATH:$(npm config get prefix)/bin"
          echo "Salesforce CLI ready: $(sf --version)"

      - name: Authenticate to Salesforce
        id: login
        timeout-minutes: 10
        run: |
          echo "=========================================="
          echo "üîê Salesforce Authentication"
          echo "=========================================="
          echo ""
          echo "Using Device Login (no Connected App required)"
          echo ""
          echo "üìã INSTRUCTIONS:"
          echo "1. Watch the logs below for a Device Login code (8 digits)"
          echo "2. Visit the URL shown below"
          echo "3. Enter the code when prompted"
          echo "4. Complete authentication on Salesforce"
          echo ""
          echo "=========================================="
          echo ""
          
          # Get instance URL from input or use default
          SF_INSTANCE_URL="${{ inputs.sf_instance_url }}"
          SF_INSTANCE_URL="${SF_INSTANCE_URL:-https://login.salesforce.com}"
          
          # Use device login (no Connected App needed)
          echo "Starting device login flow..."
          echo "Instance URL: $SF_INSTANCE_URL"
          echo ""
          echo "=========================================="
          echo "üîê DEVICE LOGIN REQUIRED"
          echo "=========================================="
          echo ""
          echo "The command below will output:"
          echo "1. A URL to visit (e.g., https://login.salesforce.com/setup/connect)"
          echo "2. An 8-digit code to enter"
          echo ""
          echo "Watch for these in the output below:"
          echo "=========================================="
          echo ""
          
          # Run device login and capture output
          sf org login device --alias targetOrg --instance-url "$SF_INSTANCE_URL" 2>&1 | tee /tmp/device_login_output.txt || {
              echo ""
              echo "‚ùå Device login failed or timed out"
              echo ""
              echo "Troubleshooting:"
              echo "- Check the logs above for the device code"
              echo "- Make sure you visit the URL and enter the code within 10 minutes"
              echo "- Verify your Salesforce org URL is correct"
              exit 1
          }
          
          echo ""
          echo "‚úÖ Authentication successful via device login!"

      - name: Deploy Assets
        run: |
          echo "üöÄ Starting deployment to Salesforce..."
          # This runs as soon as you finish the login on your machine
          sf project deploy start --source-dir force-app --target-org targetOrg --wait 10 || {
            echo "‚ùå Deployment failed"
            exit 1
          }
          echo "‚úÖ Deployment completed successfully!"

