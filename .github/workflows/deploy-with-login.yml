name: Salesforce Deployment
on:
  workflow_dispatch: # Allows manual trigger or API trigger
    inputs:
      sf_access_token:
        description: 'Salesforce Access Token (from browser login)'
        required: false
        type: string
      sf_instance_url:
        description: 'Salesforce Instance URL (e.g., https://login.salesforce.com)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          set -e  # Exit on error
          set -x  # Enable debug mode (show commands)
          
          echo "=========================================="
          echo "üì¶ Installing Salesforce CLI"
          echo "=========================================="
          echo ""
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting CLI installation check..."
          echo "Runner OS: $(uname -a)"
          echo "Working directory: $(pwd)"
          echo "User: $(whoami)"
          echo ""
          
          # Check if sf CLI is already installed
          if command -v sf &> /dev/null; then
            SF_VERSION=$(sf --version 2>&1)
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ Salesforce CLI found: $SF_VERSION"
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] CLI location: $(which sf)"
          else
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] üì¶ Salesforce CLI not found. Installing..."
            
            # Check if Node.js/npm is available
            if ! command -v npm &> /dev/null; then
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå npm is not installed. Installing Node.js..."
              # Install Node.js (required for npm)
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ Node.js installed: $(node --version)"
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ npm installed: $(npm --version)"
            else
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ npm found: $(npm --version)"
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ Node.js found: $(node --version)"
            fi
            
            echo ""
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Installing Salesforce CLI via npm..."
            echo "npm prefix: $(npm config get prefix)"
            echo "npm cache: $(npm config get cache)"
            
            npm install -g @salesforce/cli || {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå Failed to install Salesforce CLI"
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] Trying alternative installation method..."
              # Alternative: use npm with --force or try different approach
              npm install -g @salesforce/cli --force || {
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå Installation failed. Please check npm and Node.js versions."
                echo "Node version: $(node --version)"
                echo "npm version: $(npm --version)"
                echo "npm output:"
                npm list -g @salesforce/cli || true
                exit 1
              }
            }
            
            # Verify installation
            if command -v sf &> /dev/null; then
              SF_VERSION=$(sf --version 2>&1)
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ Salesforce CLI installed successfully: $SF_VERSION"
            else
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå Salesforce CLI installation completed but 'sf' command not found"
              echo "Checking PATH and installation location..."
              npm list -g @salesforce/cli || true
              echo "PATH: $PATH"
              echo "npm prefix: $(npm config get prefix)"
              echo "npm global bin: $(npm config get prefix)/bin"
              ls -la "$(npm config get prefix)/bin" | grep sf || echo "No sf binary found in npm bin directory"
              exit 1
            fi
          fi
          
          # Ensure sf is in PATH
          export PATH="$PATH:$(npm config get prefix)/bin"
          SF_VERSION=$(sf --version 2>&1)
          SF_LOCATION=$(which sf)
          echo ""
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ Salesforce CLI ready"
          echo "  Version: $SF_VERSION"
          echo "  Location: $SF_LOCATION"
          echo "  PATH: $PATH"
          echo ""

      - name: Authenticate to Salesforce
        id: login
        timeout-minutes: 10
        run: |
          set -e  # Exit on error
          set -x  # Enable debug mode (show commands)
          
          echo "=========================================="
          echo "üîê Salesforce Authentication"
          echo "=========================================="
          echo ""
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting authentication process..."
          echo ""
          
          # Get credentials from workflow inputs (from local browser login)
          SF_ACCESS_TOKEN="${{ inputs.sf_access_token }}"
          SF_INSTANCE_URL="${{ inputs.sf_instance_url }}"
          
          # Debug: Check if inputs are provided (without showing token)
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Checking workflow inputs..."
          if [ -n "$SF_ACCESS_TOKEN" ]; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ Access token provided (length: ${#SF_ACCESS_TOKEN} chars)"
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Token preview: ${SF_ACCESS_TOKEN:0:20}...${SF_ACCESS_TOKEN: -10}"
          else
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ö†Ô∏è  No access token provided"
          fi
          
          if [ -n "$SF_INSTANCE_URL" ]; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ Instance URL provided: $SF_INSTANCE_URL"
          else
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ö†Ô∏è  No instance URL provided"
          fi
          echo ""
          
          # Check if credentials provided via inputs (from local browser login)
          if [ -n "$SF_ACCESS_TOKEN" ] && [ -n "$SF_INSTANCE_URL" ]; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Using credentials from browser login..."
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Checking token format..."
            
            # Verify token format (should be "<org id>!<accesstoken>")
            # Token must contain "!" and be longer than just "test" or similar test values
            if [[ "$SF_ACCESS_TOKEN" != *"!"* ]] || [ ${#SF_ACCESS_TOKEN} -lt 20 ]; then
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå Error: Access token doesn't appear to be in correct format"
              echo "Expected format: <org id>!<accesstoken>"
              echo "Token length: ${#SF_ACCESS_TOKEN} chars"
              echo "Token preview: ${SF_ACCESS_TOKEN:0:50}..."
              echo ""
              echo "This workflow requires credentials from the trigger script."
              echo "Please run: ./trigger-deploy.sh"
              echo ""
              echo "Device Login is deprecated and no longer available."
              exit 1
            else
              # Token format looks correct, try access-token login
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] Token format looks correct. Attempting to authenticate with access token..."
              echo ""
              
              # Export access token as environment variable (required by sf CLI)
              export SF_ACCESS_TOKEN
              
              # Try access-token login (CLI reads token from SF_ACCESS_TOKEN env var)
              LOGIN_OUTPUT=$(sf org login access-token \
                --alias targetOrg \
                --instance-url "$SF_INSTANCE_URL" \
                --no-prompt 2>&1)
              LOGIN_EXIT_CODE=$?
            
              if [ $LOGIN_EXIT_CODE -eq 0 ]; then
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ Authentication successful using browser login credentials!"
                echo "$LOGIN_OUTPUT"
              else
                echo ""
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå Authentication with access token failed (exit code: $LOGIN_EXIT_CODE)"
                echo "Login output:"
                echo "$LOGIN_OUTPUT"
                echo ""
                echo "This might happen if:"
                echo "- The access token has expired (tokens expire after ~2 hours)"
                echo "- The token format is incorrect (should be: <org id>!<accesstoken>)"
                echo "- The instance URL doesn't match the token"
                echo ""
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå Authentication failed"
                echo ""
                echo "Please run the trigger script again to get fresh credentials:"
                echo "  ./trigger-deploy.sh"
                echo ""
                echo "Device Login is deprecated and no longer available."
                exit 1
              fi
            fi
          else
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå Error: No credentials provided"
            echo ""
            echo "This workflow requires Salesforce credentials from the trigger script."
            echo ""
            echo "To deploy:"
            echo "1. Run the trigger script locally: ./trigger-deploy.sh"
            echo "2. The script will authenticate you via browser login"
            echo "3. It will then trigger this workflow with your credentials"
            echo ""
            echo "Device Login is deprecated and no longer available."
            echo "You must use the trigger script to provide credentials."
            exit 1
          fi
          
          # Verify authentication worked
          echo ""
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Verifying authentication..."
          ORG_DISPLAY=$(sf org display --target-org targetOrg --json 2>&1)
          ORG_DISPLAY_EXIT=$?
          
          if [ $ORG_DISPLAY_EXIT -eq 0 ]; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ Authentication verified!"
            echo ""
            echo "Org details:"
            echo "$ORG_DISPLAY" | jq -r '.result | "  Username: \(.username)\n  Org ID: \(.id)\n  Instance URL: \(.instanceUrl)\n  Access Token: \(.accessToken[0:20])..."' || echo "$ORG_DISPLAY"
          else
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå Failed to verify authentication (exit code: $ORG_DISPLAY_EXIT)"
            echo "Error output:"
            echo "$ORG_DISPLAY"
            echo ""
            echo "Available orgs:"
            sf org list || true
            echo ""
            echo "Org might not be authenticated properly"
            exit 1
          fi
          echo ""

      - name: Deploy Assets
        run: |
          set -e  # Exit on error
          set -x  # Enable debug mode (show commands)
          
          echo "=========================================="
          echo "üöÄ Starting Deployment"
          echo "=========================================="
          echo ""
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting deployment to Salesforce..."
          echo ""
          
          # Verify org is authenticated before deploying
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Verifying target org..."
          ORG_VERIFY=$(sf org display --target-org targetOrg --json 2>&1)
          ORG_VERIFY_EXIT=$?
          
          if [ $ORG_VERIFY_EXIT -ne 0 ]; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå Target org 'targetOrg' is not authenticated (exit code: $ORG_VERIFY_EXIT)"
            echo "Error output:"
            echo "$ORG_VERIFY"
            echo ""
            echo "Available orgs:"
            sf org list || true
            exit 1
          fi
          
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ Target org verified"
          ORG_USERNAME=$(echo "$ORG_VERIFY" | jq -r '.result.username // "unknown"' 2>/dev/null || echo "unknown")
          ORG_ID=$(echo "$ORG_VERIFY" | jq -r '.result.id // "unknown"' 2>/dev/null || echo "unknown")
          echo "  Org Username: $ORG_USERNAME"
          echo "  Org ID: $ORG_ID"
          echo ""
          
          # Check what we're deploying
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Checking deployment source..."
          if [ ! -d "force-app" ]; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå force-app directory not found!"
            echo "Current directory: $(pwd)"
            echo "Directory contents:"
            ls -la || true
            exit 1
          fi
          
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ force-app directory found"
          echo "Deployment source contents:"
          find force-app -type f | head -20 || echo "No files found"
          echo ""
          
          # This runs as soon as you finish the login on your machine
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting deployment..."
          echo "Command: sf project deploy start --source-dir force-app --target-org targetOrg --wait 10"
          echo ""
          
          DEPLOY_OUTPUT=$(sf project deploy start --source-dir force-app --target-org targetOrg --wait 10 2>&1)
          DEPLOY_EXIT_CODE=$?
          
          if [ $DEPLOY_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ Deployment completed successfully!"
            echo ""
            echo "Deployment output:"
            echo "$DEPLOY_OUTPUT"
          else
            echo ""
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå Deployment failed (exit code: $DEPLOY_EXIT_CODE)"
            echo ""
            echo "Deployment output:"
            echo "$DEPLOY_OUTPUT"
            echo ""
            echo "Troubleshooting:"
            echo "- Check the error messages above"
            echo "- Verify the org has the necessary permissions"
            echo "- Ensure the metadata is valid"
            echo "- Check that the org supports the API version used"
            exit 1
          fi
          echo ""

